{% extends 'base.html' %}

{% block content %}
<h1>Список задач</h1>

<button type="button" class="btn btn-primary" data-toggle="modal" data-target="#filterModal">
    Фильтрация
</button>

<div class="modal fade" id="filterModal" tabindex="-1" role="dialog" aria-labelledby="filterModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterModalLabel">Фильтрация задач</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <form method="GET" action="{{ url_for('index') }}">
                    <div class="form-group">
                        <label for="executorFilter">Исполнитель:</label>
                        <select class="form-control" id="executorFilter" name="executor">
                            <option value="">Все</option>
                            {% for executor in executors %}
                            <option value="{{ executor.name }}" {% if executor.name == request.args.get('executor')
                                %}selected{% endif %}>{{ executor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dateFilter">Дата:</label>
                        <input type="date" class="form-control" id="dateFilter" name="date"
                            value="{{ request.args.get('date') }}">
                    </div>
                    <button type="submit" class="btn btn-primary">Применить фильтр</button>
                </form>
            </div>
        </div>
    </div>
</div>

<table class="table table-bordered">
    <thead>
        <tr>
            <th>Исполнитель</th>
            <th>Дата создания</th>
            <th>Срок</th>
            <th>Описание</th>
            <th>Статус</th> 
            <th>Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for task in tasks %}
        <tr {% if not task.is_valid %}class="table-secondary"{% elif task.is_overdue() %}class="table-danger"{% endif %}>
            <td>{{ task.executor.name }} {{ task.executor.surname }}</td>
            <td>{{ task.date_created.strftime('%d.%m.%Y') }}</td>
            <td>{{ task.deadline.strftime('%d.%m.%Y') }}</td>
            <td>{{ task.description }}</td>
            <td>
                {% if task.completion_confirmed %}
                    <span class="badge badge-success">Выполнено</span>
                    {% if task.completion_confirmed_at %}
                        <br>
                        <small class="text-muted">Подтверждено: {{ task.completion_confirmed_at.strftime('%d.%m.%Y %H:%M') }}</small>
                    {% endif %}
                {% elif not task.is_valid %}
                    <span class="badge badge-secondary">Не действительна</span>
                {% elif task.is_overdue() %}
                    <span class="badge badge-danger">Просрочена</span>
                {% else %}
                    <span class="badge badge-warning">В работе</span>
                {% endif %}
            
                {% if task.admin_note %} 
                    <br>
                    <span class="badge badge-info">Заметка админа: {{ task.admin_note }}</span>
                {% endif %}
            </td>
            <td>
                {% if current_user.is_admin %}
                <form method="POST" action="{{ url_for('delete', task_id=task.id) }}"
                    onsubmit="return confirm('Вы уверены, что хотите удалить эту задачу?');">
                    <button type="submit" class="btn btn-danger btn-sm">Удалить</button>
                </form>
                <a href="{{ url_for('edit', task_id=task.id) }}" class="btn btn-primary btn-sm">Редактировать</a>
                {% endif %}

                {% if current_user.id == task.executor_id and task.is_valid and not task.completion_confirmed %}
                <a href="{{ url_for('complete', task_id=task.id) }}" class="btn btn-success btn-sm">Выполнить</a>
                {% endif %}

                {% if current_user.is_admin and task.completion_note and not task.completion_confirmed %}
                <button type="button" class="btn btn-info btn-sm" data-toggle="modal"
                    data-target="#confirmModal{{ task.id }}">
                    Подтвердить выполнение
                </button>

                <div class="modal fade" id="confirmModal{{ task.id }}" tabindex="-1" role="dialog"
                    aria-labelledby="confirmModalLabel{{ task.id }}" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="confirmModalLabel{{ task.id }}">Подтверждение выполнения
                                    задачи
                                </h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">×</span>
                                </button>
                            </div>
                            <div class="modal-body">
                                <p>Задача: {{ task.description }}</p>
                                <p>Заметка исполнителя: {{ task.completion_note }}</p>
                                <form method="POST" action="{{ url_for('confirm_task', task_id=task.id) }}">
                                    <div class="form-group">
                                        <label for="admin_note">Заметка администратора:</label>
                                        <textarea class="form-control" id="admin_note" name="admin_note"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-success">Подтвердить</button>
                                </form>
                                <form method="POST" action="{{ url_for('reject_task', task_id=task.id) }}">
                                    <div class="form-group">
                                        <label for="admin_note">Причина отклонения:</label>
                                        <textarea class="form-control" id="admin_note" name="admin_note"></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-danger">Отклонить</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if current_user.is_admin %}
<a href="{{ url_for('add') }}" class="btn btn-success">Добавить задачу</a>
{% endif %}

{% endblock %}